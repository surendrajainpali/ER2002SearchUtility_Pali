<script>
  const statusEl = document.getElementById('status');
  const searchBox = document.getElementById('searchBox');
  const oldAcInput = document.getElementById('oldAcInput');
  const partNoInput = document.getElementById('partNoInput');
  const tableBody = document.querySelector('#resultsTable tbody');
  const pagination = document.getElementById('pagination');
  const constituencySelect = document.getElementById('constituencySelect');

  let data = [];
  let filtered = [];
  let currentPage = 1;
  const resultsPerPage = 20;

  const constituencyChunks = {
    '117-‡§∏‡•ã‡§ú‡§§': 12,
    '118-‡§™‡§æ‡§≤‡•Ä': 9,
    '119-‡§Æ‡§æ‡§∞‡§µ‡§æ‡•ú ‡§ú‡§Ç‡§ï‡•ç‡§∂‡§®': 10,
    '120-‡§¨‡§æ‡§≤‡•Ä': 12,
    '121-‡§∏‡•Å‡§Æ‡•á‡§∞‡§™‡•Å‡§∞': 11
  };

  function normalize(value) {
    return value !== undefined && value !== null
      ? String(value).replace(/\s+/g, ' ').trim().toLowerCase()
      : '';
  }

  function filterData() {
    const nameQuery = normalize(searchBox.value);
    const oldAcQuery = normalize(oldAcInput.value);
    const partNoQuery = normalize(partNoInput.value);

    filtered = data.filter(row => {
      const rowOldAc = normalize(row['Old AC No.']);
      const rowPartNo = normalize(row['Part No.']);
      const rowName = normalize(row['Name']);
      const rowRelative = normalize(row['Relative Name']);
      const rowEpic = normalize(row['EPIC']);

      const matchName =
        rowName.includes(nameQuery) ||
        rowRelative.includes(nameQuery) ||
        rowEpic.includes(nameQuery);

      const matchOldAc = oldAcQuery === '' || rowOldAc === oldAcQuery;
      const matchPartNo = partNoQuery === '' || rowPartNo === partNoQuery;

      if (nameQuery === '' && oldAcQuery === '' && partNoQuery === '') return true;
      if (nameQuery !== '' && oldAcQuery === '' && partNoQuery === '') return matchName;
      if (nameQuery === '' && (oldAcQuery !== '' || partNoQuery !== '')) return matchOldAc && matchPartNo;
      return matchName && matchOldAc && matchPartNo;
    });
  }

  function renderPage() {
    tableBody.innerHTML = '';
    const start = (currentPage - 1) * resultsPerPage;
    const end = start + resultsPerPage;
    const pageData = filtered.slice(start, end);

    if (pageData.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="8">‚ö†Ô∏è ‡§ï‡•ã‡§à ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ</td></tr>';
      pagination.innerHTML = '';
      return;
    }

    pageData.forEach(row => {
      const tr = document.createElement('tr');
      ['Old AC No.', 'Part No.', 'S. NO.', 'H. NO.', 'Name', 'Relative Name', 'Age', 'EPIC'].forEach(key => {
        const raw = row[key] || '';
        const normalizedRaw = normalize(raw);
        let highlighted = raw;

        const nameQuery = normalize(searchBox.value);
        if (nameQuery && ['Name', 'Relative Name', 'EPIC'].includes(key)) {
          const index = normalizedRaw.indexOf(nameQuery);
          if (index !== -1) {
            const start = raw.substring(0, index);
            const match = raw.substring(index, index + nameQuery.length);
            const end = raw.substring(index + nameQuery.length);
            highlighted = `${start}<mark>${match}</mark>${end}`;
          }
        }

        const td = document.createElement('td');
        td.innerHTML = highlighted;
        tr.appendChild(td);
      });
      tableBody.appendChild(tr);
    });

    updatePaginationControls();
  }

  function updatePaginationControls() {
    pagination.innerHTML = '';
    const totalPages = Math.ceil(filtered.length / resultsPerPage);
    if (totalPages <= 1) return;

    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‚¨ÖÔ∏è ‡§™‡§ø‡§õ‡§≤‡§æ';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
      currentPage--;
      renderPage();
    };

    const nextBtn = document.createElement('button');
    nextBtn.textContent = '‚û°Ô∏è ‡§Ö‡§ó‡§≤‡§æ';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => {
      currentPage++;
      renderPage();
    };

    pagination.appendChild(prevBtn);
    pagination.appendChild(nextBtn);
  }

  constituencySelect.addEventListener('change', () => {
    const selected = constituencySelect.value;
    if (!selected) return loadAllData();

    statusEl.textContent = 'üîÑ ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...';
    statusEl.classList.add('loading');

    const chunkCount = constituencyChunks[selected];
    const chunkPaths = Array.from({ length: chunkCount }, (_, i) =>
      `data/${encodeURIComponent(selected)}/data${i + 1}.json`
    );

    Promise.allSettled(
      chunkPaths.map(path =>
        fetch(path).then(r => r.ok ? r.json() : []).catch(() => [])
      )
    ).then(results => {
      data = results.filter(r => r.status === 'fulfilled').flatMap(r => r.value);
      searchBox.disabled = false;
      oldAcInput.value = '';
      partNoInput.value = '';
      searchBox.value = '';
      currentPage = 1;
      filterData();
      renderPage();
      statusEl.textContent = `‚úÖ ‡§ï‡•Å‡§≤ ${data.length} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•Å‡§è (${selected})`;
      statusEl.classList.remove('loading');
      statusEl.classList.add('loaded');
    });
  });

  function loadAllData() {
    statusEl.textContent = 'üîÑ ‡§∏‡§≠‡•Ä ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...';
    statusEl.classList.add('loading');

    const allChunkPaths = Object.entries(constituencyChunks).flatMap(([name, count]) =>
      Array.from({ length: count }, (_, i) => `data/${encodeURIComponent(name)}/data${i + 1}.json`)
    );

    Promise.allSettled(
      allChunkPaths.map(path =>
        fetch(path).then(r => r.ok ? r.json() : []).catch(() => [])
      )
    ).then(results => {
      data = results.filter(r => r.status === 'fulfilled').flatMap(r => r.value);
      searchBox.disabled = false;
      oldAcInput.value = '';
      partNoInput.value = '';
      searchBox.value = '';
      currentPage = 1;
      filterData();
      renderPage();
      statusEl.textContent = `‚úÖ ‡§ï‡•Å‡§≤ ${data.length} ‡§∞‡§ø‡§ï‡•â‡§∞‡•ç‡§° ‡§≤‡•ã‡§° ‡§π‡•Å‡§è (‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§ß‡§æ‡§®‡§∏‡§≠‡§æ)`;
      statusEl.classList.remove('loading');
      statusEl.classList.add('loaded');
    });
  }

  [searchBox, oldAcInput, partNoInput].forEach(input =>
    input.addEventListener('input', () => {
      currentPage = 1;
      filterData();
      renderPage();
    })
  );

  document.getElementById('clearFilters').addEventListener('click', () => {
    oldAcInput.value = '';
    partNoInput.value = '';
    searchBox.value = '';
    currentPage = 1;
    filterData();
    renderPage();
  });

  window.addEventListener('DOMContentLoaded', loadAllData);
</script>
